<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Circular Conference Visualization</title>
    <meta name="description" content="Circular Conference Visualization">
    <!-- <link rel="stylesheet" href="main.css">
    <script src="math.js" type="text/javascript"></script>
-->
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

    <style>
        .container {
            float: left;
        }
        body {
            height: 100%;
            margin: 0px;
            padding: 0px;
        }
        html {
            height: 100%;
        }
        div.fixed-rectangle {
            width: 100%;
            height: 9%;
            background-color: #AD193D;
        }
    </style>

</head>
<body style="background-color:#e8e8e8;">

<div class="container" id="chart1">
</div>

<div class="fixed-rectangle"></div>

<p style="position: absolute; top: 83.5%; left: 37.6%; line-height: 30px;">Upload or Save Conferences
    <input type="file" id="file_conference_data" accept=".txt" style="position: absolute; border: thin solid #ad193d; width: 87px; top: 85%; left: 0%;">
    <button id="buttonExportConferenceData" style="position: absolute; top: 85%; left: 50%; border: thin solid #ad193d;">Export Data</button>
</p>

<a download="info.txt" id="downloadlink" style="display: none; position: absolute; top: 85%; left: 25%;">Download</a>

<p style="position: absolute; font-size:30px; font-style: italic; color: whitesmoke; top: 0%; left: 1%;">Conference Cycle Visualization</p>

<button id="buttonEnterFields" style="position: absolute; border: solid #ad193d; top:11%; left:1%;" onclick="enterFields()">Enter A Conference</button>


    <script type="text/javascript" src="VisualizationHandler.js"></script>
    <script type="text/javascript" src="Conference.js"></script>
    <script type="text/javascript" src="DataHandler.js"></script>

    <script>
        // declare variable used to keep track of what conference is being looked at currently
        var selected_conf_index;

        // initialize conferences array that will hold all data about conferences
        var conferences = [];
        
        function getRandomColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
              color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }
        
        function parseDate(s) {
            var b = s.split(/\D/);
            return new Date(b[0], --b[1], b[2]);
        }

        function showDetails(svg, document, conferences_handler, data_handler, conference) {
            // create Date obj
            var now = new Date();

            // new elements are added dynamically on conference visualization click. This means that objects
            // need to be deleted and re-added each time a new conference is clicked. This array and for loop
            //
            // handles conference descriptive element deletions
            var details_element_ids = ["conferenceName", "mainParagraph", "deleteButton"];
            for (var i = 0; i < details_element_ids.length; i++) {
                if (document.getElementById(details_element_ids[i])){
                    var elem = document.getElementById(details_element_ids[i]);
                    elem.remove();
                }
            }

            //create a new container that will appear on the left side of the screen
            var container2 = document.createElement("div");
            container2.setAttribute("style","float: left;");
            document.body.appendChild(container2);

            var container3 = document.createElement("div2");
            container3.setAttribute("style","float: absolute;");
            container3.style.position = "absolute";
            container3.style.left = 1026 + 'px';
            container3.style.top = 460 +'px';
            container3.style.border = "thin solid" + conference.conf_color;
            document.body.appendChild(container3);

            // Header element, will contain Conference Name
            var h1 = document.createElement('h1');
            h1.id = "conferenceName";
            h1.textContent = conference.conf_name;
            h1.style.color = conference.conf_color;
            var left = document.clientWidth/2;
            var top = document.clientHeight/2;
            //h1.style.left = left;
            //h1.style.top = top;
            //h1.setAttribute("style", "position: left; z-index: 1; left: "+left+"; top: "+top+"; width:200px; height:20px;");
            //h1.style.zIndex = 1;
            container2.appendChild(h1);
            //container2.appendChild(h1);

            // Paragraph element, unknown what this will contain
            var p1 = document.createElement('p1');
            p1.id = "mainParagraph";
            p1.setAttribute("style", "white-space: pre; position: absolute; font-size:20px; z-index: 1; left: "+left+"; top: "+top+"; width:710px; height:275px;");
            p1.textContent = "Conference Topic: " + conference.conf_field + "\r\nLocation: " + conference.conf_location + "\r\nSubmission Deadline: " +
                data_handler.convertNumToDate(new Date(), conference.submission_deadline) + "\r\nNotification Deadline: " +
                data_handler.convertNumToDate(new Date(), conference.notification_deadline) + "\r\nFinal Version Due: " +
                data_handler.convertNumToDate(new Date(), conference.decision_deadline);
            p1.setAttribute('class', 'note');
            p1.setAttribute('vertical-align', 'baseline');
            p1.style.border = "thick solid #F3EBCE";
            p1.style.backgroundColor = "linen";
            container2.appendChild(p1);

            var deleteButton = document.createElement("button");
            deleteButton.innerHTML = "Delete Conference";
            deleteButton.id = "deleteButton";
            deleteButton.width = "20px";
            deleteButton.height = "100px";
            deleteButton.top = "100px";
            deleteButton.left = "20px";
            container3.appendChild(deleteButton);

            deleteButton.onclick = function() {
                conferences_handler.num_confs = VisualizationHandler.delAndUpdate(svg, document, conferences_handler, selected_conf_index, 20, 10);
            };
        }
        
        
        
    
        // Button click event function for manually creating a conference
        function enterFields(svg, document, conferences_handler, color) {
    
            // Open pop-up window to input manual data
            let newWindow = window.open("about:blank", "Conference Details", "width=750,height=500");
    
            //////////////////////// NON-MANUAL CONFERENCE ENTRY METHODS ////////////////////////
            // Allow for searching for a conference with it's title and a search bar
            var confTS = newWindow.document.createElement('confTS');
            confTS.setAttribute('style', 'white-space: pre;');
            confTS.textContent = "Search Conference by Title \r\n";
            confTS.style.fontWeight = 'bold';
    
            // Allow for searching conference by URL
            var confURLS = newWindow.document.createElement('confURLS');
            confURLS.setAttribute('style', 'white-space: pre;');
            confURLS.textContent = "\r\nLoad Conference by WikiCFP URL:\r\n";
            confURLS.style.fontWeight = 'bold';
    
            ////////////////////////////////////// OR //////////////////////////////////////
            var Or = newWindow.document.createElement('Or');
            Or.setAttribute('style', 'white-space: pre;');
            Or.textContent = "\r\nOR..";
            Or.style.fontWeight = 'bold';

            var confDet = newWindow.document.createElement('confDet');
            confDet.setAttribute('style', 'white-space: pre;');
            confDet.textContent = "\r\nManually Enter Conference Details";
            confDet.style.fontWeight = 'bold';
            confDet.style.fontSize = '21';
            confDet.style.color = '#850200';
    
            //Ask user for conference information
            //Ask user for where the conference is taking place
            var confPlc = newWindow.document.createElement('confPlc');
            confPlc.setAttribute('style', 'white-space: pre;');
            confPlc.textContent = "\r\nPlease Enter the Location of your Conference (City,State,Country):";
            confPlc.style.fontWeight = 'bold';

            //Ask user for start date
            var confDate = newWindow.document.createElement('confPlc');
            confDate.setAttribute('style', 'white-space: pre;');
            confDate.textContent = "\r\nPlease Enter the Start and End Dates of the Conference (Start-End)";
            confDate.style.fontWeight = 'bold';
    
            //ask user for conference name
            var conf = newWindow.document.createElement('conf');
            conf.setAttribute('style', 'white-space: pre;');
            conf.textContent = "\r\nPlease Enter your Conference Name/Title:";
            conf.style.fontWeight = 'bold';
            
            //ask user for conference field
            var field = newWindow.document.createElement('conf');
            field.setAttribute('style', 'white-space: pre;');
            field.textContent = "\r\nPlease Enter your Conference Field:";
            field.style.fontWeight = 'bold';
    
            //Ask User for submission deadline
            var sub = newWindow.document.createElement('conf');
            sub.setAttribute('style', 'white-space: pre;');
            sub.textContent = "\r\nPlease Select the Submission Deadline:";
            sub.style.fontWeight = 'bold';
    
            //Ask the user for a notification deadline
            var notif = newWindow.document.createElement('notif');
            notif.setAttribute('style', 'white-space: pre;');
            notif.textContent = "\r\nPlease Select the Notification Deadline:";
            notif.style.fontWeight = 'bold';
    
            //Ask user for decision deadline
            var dec = newWindow.document.createElement('conf');
            dec.setAttribute('style', 'white-space: pre;');
            dec.textContent = "\r\nPlease Select the Final Version Deadline:";
            dec.style.fontWeight = 'bold';

            //White space
            var wt = newWindow.document.createElement('wt');
            wt.setAttribute('style', 'white-space: pre;');
            wt.textContent = "\r\n";

            //Dash
            var dash = newWindow.document.createElement('dash');
            dash.setAttribute('style', 'white-space: pre;');
            dash.textContent = " - ";
    
            /////////////////////////// inputs ////////////////////////////////
            //input text box for searching by conference name
            var inputConferenceTitle = newWindow.document.createElement("input");
            inputConferenceTitle.setAttribute('type', 'text');
            
            //input text box for searching by conference URL
            var inputConferenceURL = newWindow.document.createElement("input");
            inputConferenceURL.setAttribute('type0', 'text');
    
            //input text box for searching by conference name
            var inputConfPlc = newWindow.document.createElement("input");
            inputConfPlc.setAttribute('type1', 'text');

            //input text box for conference name
            var inputConference = newWindow.document.createElement("input");
            inputConference.setAttribute('type2', 'text');

            //input text box for conference start date
            var inputConfStart = newWindow.document.createElement("input");
            inputConfStart.type = "date";
            inputConfStart.style.width = '130px';

            //input text box for conference end date
            var inputConfEnd = newWindow.document.createElement("input");
            inputConfEnd.type = "date";
            inputConfEnd.style.width = '130px';
            
            var inputField = newWindow.document.createElement("input");
            inputField.setAttribute('type', 'text');
    
            //input text box for submission deadline
            var inputSub = newWindow.document.createElement("input");
            inputSub.type = "date";
            inputSub.style.width = '130px';
    
            //input text box for notification deadline
            var inputConferenceNotif = newWindow.document.createElement("input");
            inputConferenceNotif.type = "date";
            inputConferenceNotif.style.width = '130px';
    
            //input text box for decision deadline
            var inputDec = newWindow.document.createElement("input");
            inputDec.type = "date";
            inputDec.style.width = '130px';
    
            /////////////////////////////// SUBMIT /////////////////////////////////
            //create a submit button that will call the function to save inputs
            var submit_button = newWindow.document.createElement("button");
            submit_button.innerHTML = "Done";
            submit_button.id = "submit_button";
            submit_button.width = "20px";
            submit_button.height = "100px";
            submit_button.top = "100px";
            submit_button.left = "20px";
    
            submit_button.onclick = function() {
                //create an array to append the data entered for a new conference
                var newConference = [];
    
                //save new conference title
                var inTitle = inputConferenceTitle.value;       
                newConference.push(inTitle);                //0
    
                //save new conference URL
                var inURL = inputConferenceURL.value;
                newConference.push(inURL);                  //1 conf url
    
                //save new conference name
                var inConf = inputConference.value;
                newConference.push(inConf);                 //2 conf name
                
                //save new conference field
                var inField = inputField.value;
                newConference.push(inField);                //3 conf field
    
                //save the new conferences submission deadline
                var inSub = inputSub.value;
                newConference.push(inSub);                  //4 submission_deadline
    
                //save the notification deadline
                var inNotif = inputConferenceNotif.value;
                newConference.push(inNotif);                //5 notification_deadline
    
                //save the new conferences decision deadline
                var inDec = inputDec.value;
                newConference.push(inDec);                  //6 decision_deadline

                //save the new conference start date
                var inStart = inputConfStart.value;
                newConference.push(inStart);                //7 conf start date

                //save the new conference end date
                var inEnd = inputConfEnd.value;
                newConference.push(inEnd);                  //8 conf end date


                console.log(newConference);
                
                /////////////////////////////////////////////////////////////////////////////
                var spacing = 20;
                var ring_size = 3;
                var arc_size = 10;
                
                console.log("parseDate: ", parseDate(newConference[4]), data_handler.convertDateToNum(parseDate(newConference[4])), data_handler.convertDateToNum(parseDate(newConference[6])));
                
                conferences_handler.submission_deadlines.push(data_handler.convertDateToNum(parseDate(newConference[4])));
                conferences_handler.decision_deadlines.push(data_handler.convertDateToNum(parseDate(newConference[6])));
                
                console.log("Num", conferences_handler.submission_deadlines[conferences_handler.conferences.length]);
                
                console.log((((conferences_handler.submission_deadlines[conferences_handler.conferences.length])/365) * (2*Math.PI)));
                
                var updated_inner_radius = conferences_handler.curr_radius - arc_size/2;
                var updated_outer_radius = conferences_handler.curr_radius + arc_size/2;
                var updated_start_angle = (((conferences_handler.submission_deadlines[conferences_handler.conferences.length])/365) * (2*Math.PI));
                var updated_end_angle = (((conferences_handler.decision_deadlines[conferences_handler.conferences.length])/365) * (2*Math.PI));
                var updated_conf_dates_start_angle = (((conferences_handler.conferenceStart_dates[conferences_handler.conferences.length])/365) * (2*Math.PI));
                var updated_conf_dates_end_angle = (((conferences_handler.conferenceEnd_dates[conferences_handler.conferences.length])/365) * (2*Math.PI));
                
                conferences_handler.addConference(svg, document, conferences_handler, data_handler, conferences_handler.num_confs + 1, newConference[2], newConference[1],
                                conferences_handler.conferences.length, conferences_handler.x, conferences_handler.y, newConference[3], getRandomColor(),
                                data_handler.convertDateToNum(parseDate(newConference[4])), data_handler.convertDateToNum(parseDate(newConference[6])), // conf submission, decision deadlines
                                data_handler.convertDateToNum(parseDate(newConference[7])), data_handler.convertDateToNum(parseDate(newConference[8])), // conf start, end dates
                                data_handler.convertDateToNum(parseDate(newConference[5])), // conf notification deadline
                                conferences_handler.curr_radius, updated_inner_radius, updated_outer_radius, updated_start_angle,
                                updated_end_angle, updated_conf_dates_start_angle, updated_conf_dates_end_angle, 3, 10, conferences_handler.conferences);
                conferences_handler.num_confs += 1;
                
                console.log(conferences_handler.conferences);
                
                // display array for checking, close window, and return array containing new conference details
                console.log(newConference);
                console.log("Done");
                newWindow.close();
                return newConference;
            };
    
            //Add all elements to the pop-up window
            newWindow.document.body.appendChild(confTS);
            newWindow.document.body.appendChild(inputConferenceTitle);
            newWindow.document.body.appendChild(wt.cloneNode(true));
            newWindow.document.body.appendChild(confURLS);
            newWindow.document.body.appendChild(inputConferenceURL);
            newWindow.document.body.appendChild(wt.cloneNode(true));
            newWindow.document.body.appendChild(Or);
            newWindow.document.body.appendChild(wt.cloneNode(true));
            newWindow.document.body.appendChild(confDet);
            newWindow.document.body.appendChild(wt.cloneNode(true));
            newWindow.document.body.appendChild(confPlc);
            newWindow.document.body.appendChild(inputConfPlc);
            newWindow.document.body.appendChild(confDate);
            newWindow.document.body.appendChild(inputConfStart);
            newWindow.document.body.appendChild(dash);
            newWindow.document.body.appendChild(inputConfEnd);
            newWindow.document.body.appendChild(conf);
            newWindow.document.body.appendChild(inputConference);
            newWindow.document.body.appendChild(field);
            newWindow.document.body.appendChild(inputField);
            newWindow.document.body.appendChild(sub);
            newWindow.document.body.appendChild(inputSub);
            newWindow.document.body.appendChild(notif);
            newWindow.document.body.appendChild(inputConferenceNotif);
            newWindow.document.body.appendChild(dec);
            newWindow.document.body.appendChild(inputDec);
            newWindow.document.body.appendChild(wt.cloneNode(true));
            newWindow.document.body.appendChild(submit_button);
        }
    
    
        /*
         * main function call
         */
        function init() {
            //svg creation
            var svg_width = document.body.clientWidth / 2;
            var svg_height = document.body.clientHeight;
            var svg = d3.select("#chart1").append("svg").attr("width", svg_width)
                                                     .attr("height", svg_height);
                                                     
            // dataHandler object for any functions having to do with data handling (self explanatory)
            data_handler = new dataHandler();
            
            console.log("Successfully created data handler: ", data_handler);
            
            // handle grabbing file and populating conferences array with necessary data
            var finished_processing_data = false;
            
            const file_conference_data = document.getElementById('file_conference_data');
            file_conference_data.addEventListener('change', (event) => {
                const file_list = event.target.files;
                
                var reader = new FileReader();
                reader.onload = function(event) {
                    conference_file_text = event.target.result;
                    conferences = data_handler.grabConferenceData(conference_file_text);
                    
                    finished_processing_data = true;
                    
                    ////////////////////////////// INITIALIZATION OF VISUALIZATION HAS MOVED HERE //////////////////////////////////////////
                    //create conferences & their visuals and add all info to conferences_handler object
                    var conferences_handler = new VisualizationHandler(svg, document, svg_width/2, svg_height/2, conferences, num_confs, data_handler);
                    console.log("Successfully created conferences_handler: ", conferences_handler);

                    //create months ring
                    conferences_handler.createMonthsRing(svg, conferences_handler.x, conferences_handler.y);
            
                    //create date line
                    var now = new Date();
                    conferences_handler.createDateLine(svg, data_handler, now, conferences_handler.x, conferences_handler.y, conferences_handler.curr_radius);
                
                    //handle onclick event for enterFields button (if 10 or more conferences made do not allow creation of another)
                    if (conferences_handler.num_confs >= 10) {
                        console.log("Maximum number of conferences allowed has been reached. " +
                                    "Please delete a conference before adding a new one.");
                    } else {
                        var button_enter_fields = document.getElementById("buttonEnterFields");
                        button_enter_fields.onclick = function () {
                            var color = "#AD193D";
                            var conference_info = enterFields(svg, document, conferences_handler, color);
                        };
                    }
                
                    //handle onclick event for exportData button
                    var button_export_data = document.getElementById("buttonExportConferenceData");
                    button_export_data.onclick = function() {
                        var download_link = document.getElementById("downloadlink");
                        download_link.href = data_handler.exportConferenceData(conferences_handler.conferences, data_handler);
                        download_link.style.display = 'block';
                    };
                
                };
                reader.readAsText(file_list[0]);
            });
    
    
            // conference temp. variables
            // having to do with creating visual aspect of conference
            var num_confs = 3;
            
            ////////////////////// NO LONGER NECESSARY, conferences POPULATED ABOVE //////////////
            //// more conference information
            //var conferences = [["IEEE CAMAD 2020", "Robotics", "#f08950", 24, 32, 48, 5, 9],
            //                   ["RAI--Ei and Scopus 2020", "AI", "#9ce490", 46, 80, 102, 6, 10],
            //                   ["IWSMR 2020", "Physics", "#90c6e4", 52, 96, 256, 5, 11]];
            //
            //
            ////var conf_names = ["IEEE CAMAD 2020", "RAI--Ei and Scopus 2020", "IWSMR 2020"];
            ////var conf_locations = ["Denver,CO,US", "Boston,MA,US", "Pittsburgh,PA,US"];
            ////var conf_fields = ["Robotics", "AI", "Physics"];
            ////var conf_colors = ["#f08950", "#9ce490", "#90c6e4"];
            ////var conferenceStart_dates = [5, 6, 5];
            ////var conferenceEnd_dates = [9, 10, 11];
            ////var notification_deadlines = [1, 4, 17];
            ////var submission_deadlines = [24, 46, 52];
            ////var decision_deadlines = [48, 102, 256];
    
            //TESTING, can be deleted if necessary
            //console.log(conferences_handler.names);
    
            // UNDER CONSTRUCTION
            // STILL NEED TO REMOVE CONFERENCE FROM conferences, AND CHECK IF I NEED TO DO ANYTHING ELSE FOR DELETION
            //num_confs = Conference.delAndUpdateConfVis(svg, conferences[2], num_confs, spacing, conferences, document, arc_size);
        }
    
        //calls main function using
        $(document).ready(function() {
            console.log("Start");
            init();
        });
    
    </script>


</body>
</html>
