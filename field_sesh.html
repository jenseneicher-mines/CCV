<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Circular Conference Visualization</title>
    <meta name="description" content="Circular Conference Visualization">
    <!-- <link rel="stylesheet" href="main.css">
    <script src="math.js" type="text/javascript"></script>
-->
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

    <style>
        .container {
            float: left;
        }
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        html {
            height: 100%;
        }
    </style>

</head>
<body>

<div class="container" id="chart1">
</div>

<button style="position: absolute; top:100px; left:20px;" onclick="enterFields()">Enter A Conference</button>

<script>
    /*
     * className
     * @param firstArgName
     */
    class dataHandler {
        /*
         * docstring
         */
        constructor() {}

        convertDateToNum(now) {
            var start = new Date(now.getFullYear(), 0, 0);
            var diff = (now - start) + ((start.getTimezoneOffset() - now.getTimezoneOffset()) * 60 * 1000);
            var oneDay = 1000 * 60 * 60 * 24;
            var day = Math.round(diff / oneDay);
            console.log('Day of year: ' + day);
            return day;
        }

        convertNumToDate(now, now_num) {
            var date = new Date(now.getFullYear(), 0); // initialize a date in `year-01-01`
            return new Date(date.setDate(now_num)); // add the number of days
        }
    }



    /*
     * className
     * @param firstArgName
     */
    class VisualizationHandler {
        /*
         * docstring
         */
        constructor(svg, document, x, y, conferences, conf_count, names, fields, colors, submission_deadlines, decision_deadlines, conferenceStart_dates, conferenceEnd_dates, notification_deadlines, conf_locations) {
            this.svg = svg;
            this.document = document;
            this.x = x;
            this.y = y;

            this.conferences = conferences;
            this.conf_count = conf_count;
            this.names = names;
            this.fields = fields;
            this.colors = colors;
            this.submission_deadlines = submission_deadlines;
            this.decision_deadlines = decision_deadlines;
            this.conferenceStart_dates = conferenceStart_dates;
            this.conferenceEnd_dates = conferenceEnd_dates;
            this.notification_deadlines = notification_deadlines;
            this.conf_locations = conf_locations;
            this.radii = [];
            this.inner_radii = [];
            this.outer_radii = [];
            this.start_angles = [];
            this.end_angles = [];
            this.rings = [];
            this.arcs = [];
            this.self = this;

            this.curr_radius = 200;

            // variables necessary for visual creation
            var spacing = 20;
            var ring_size = 3;
            var arc_size = 10;

            // populate conferences array & fill other empty arrays
            for (var i = 0; i < conf_count; i++) {
                // add math related translations for arc creation
                this.radii.push(this.curr_radius);
                this.inner_radii.push(this.curr_radius - arc_size/2);
                this.outer_radii.push(this.curr_radius + arc_size/2);
                this.start_angles.push(((submission_deadlines[i])/365) * (2*Math.PI));
                this.end_angles.push(((decision_deadlines[i])/365) * (2*Math.PI));

                // handle single conference creation
                this.addConference(svg, document, this.names[i], i, this.x, this.y, this.fields[i], this.colors[i],
                    this.submission_deadlines[i], this.decision_deadlines[i], this.conferenceStart_dates[i], this.conferenceEnd_dates[i], this.notification_deadlines[i], this.conf_locations[i],
                    this.curr_radius, this.inner_radii[i], this.outer_radii[i], this.start_angles[i], this.end_angles[i], ring_size, arc_size,
                    this.conferences, this.rings, this.arcs);

                // update curr_radius
                this.curr_radius += spacing;
            }

        }

        addConference(svg, document, name, i, x, y, field, color, submission_deadline, decision_deadline, conferenceStart_dates, conferenceEnd_dates, notification_deadlines, conf_locations, curr_radius, inner_radius, outer_radius,
                      start_angle, end_angle, ring_size, arc_size, conferences, rings, arcs) {
            var conf = new Conference(name, i, x, y, field, color, submission_deadline, decision_deadline, conferenceStart_dates, conferenceEnd_dates, notification_deadlines, conf_locations,
                curr_radius, inner_radius, outer_radius, start_angle, end_angle, null, null);

            //Create conferences visuals and add to visualization handler arrays 'rings' and 'arcs's
            Conference.createConfVisuals(svg, document, conf, conf.x, conf.y, conf.radius, conf.start_angle, conf.end_angle, conf.conf_color, ring_size, arc_size);
            rings.push(conf.ring);
            arcs.push(conf.arc);

            conferences.push(conf);
        }

        createDateLine(svg, data_handler, now, x, y, r) {
            //handle date conversion for finding correct angle
            var converted_date = data_handler.convertDateToNum(now);
            console.log(converted_date);
            var date_angle = (converted_date/365) * (2*Math.PI);
            console.log(date_angle);
            var newly_built_date_line = d3.svg.line.radial().angle(date_angle).radius(function(d) { return d; } );
            console.log(newly_built_date_line);

            //MAGIC NUMBER 15 LOOKIN REEEEAAAAAL SHIT
            var date_line = svg.append("line").attr("x1", x).attr("y1", y)
                .attr("x2", x + (r - 15)*Math.cos(date_angle)).attr("y2", y + (r - 15)*Math.sin(date_angle))
                .attr("stroke-width", 2).attr("stroke", "black");
            return date_line;
        }

        createMonthsRing(svg, x, y) {
            var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            var month_arcs = [];
            var spacing = (0.05*((2*Math.PI)/12));
            var arc_length = (((2*Math.PI)/12) - (2*spacing));
            console.log(arc_length);
            var start_angle = spacing;
            var end_angle = arc_length - spacing;
            console.log(start_angle, end_angle);

            //var months_text_arc = d3.svg.arc().innerRadius(180).outerRadius(185)
            //                                  .startAngle(0).endAngle(360);
            //var new_month_arc = svg.append("path").attr("id", "path_text_months").attr("d", months_text_arc)
            //                                      .attr("transform", "translate("+x+", "+y+")")
            //                                      .attr("fill", "none").style("stroke", "#AAAAAA");


            for (var i = 0; i < 12; i++) {
                //init. and append new conference arc to svg
                var newly_built_arc = d3.svg.arc().innerRadius(170)
                    .outerRadius(190)
                    .startAngle(start_angle)
                    .endAngle(end_angle);

                var new_month_arc = svg.append("path").attr("id", months[i] + "_arc").attr("d", newly_built_arc).attr("transform", "translate("+x+", "+y+")").style("fill", "green");



                //var months_text_arc = svg.append("path").attr("id", "path_text_months").attr("d", "M75,300 A125,125 0 0,1 325,300").attr("fill", "none").style("stroke", "#AAAAAA");
                var months_text = svg.append("text").attr("id", months[i])
                    .attr("x", 20)   //Move the text from the start angle of the arc
                    .attr("dy", 18) //Move the text down
                    .append("textPath").attr("xlink:href", "#"+months[i]+"_arc").style("text-anchor", "middle").text(months[i]);

                month_arcs.push(new_month_arc);
                start_angle += arc_length + 2*spacing;
                end_angle += arc_length + 2*spacing;
            }
        }
    }

    // Button for manually creating a conference
    function enterFields() {

        // Open pop-up window to input manual data
        let newWindow = window.open("about:blank", "Conference Details", "width=700,height=400");

        // Allow for searching for a conference
        var confTS = newWindow.document.createElement('confTS');
        confTS.setAttribute('style', 'white-space: pre;');
        confTS.textContent = "Search conference by title:"

        // Allow for searching conference by URL
        var confURLS = newWindow.document.createElement('confURLS');
        confURLS.setAttribute('style', 'white-space: pre;');
        confURLS.textContent = "\r\nLoad Conference by WikiCFP URL:";

        //OR
        var Or = newWindow.document.createElement('Or');
        Or.setAttribute('style', 'white-space: pre;');
        Or.textContent = "\r\nOR.." + "\r\nManually Enter Conference Details";

        //Ask user for conference information
        //Ask user for where the conference is taking place
        var confPlc = newWindow.document.createElement('confPlc');
        confPlc.setAttribute('style', 'white-space: pre;');
        confPlc.textContent = "\r\nPlease enter the location of your conference (City,State,Country):";

        //ask user for conference name
        var conf = newWindow.document.createElement('conf');
        conf.setAttribute('style', 'white-space: pre;');
        conf.textContent = "\r\nPlease Enter your Conference Name/Title:";

        //Ask User for submission deadline
        var sub = newWindow.document.createElement('conf');
        sub.setAttribute('style', 'white-space: pre;');
        sub.textContent = "\r\nPlease enter the submission deadline (mm/dd/yyyy):";

        //Ask the user for a notification deadline
        var notif = newWindow.document.createElement('notif');
        notif.setAttribute('style', 'white-space: pre;');
        notif.textContent = "\r\nPlease Enter the notification deadline (mm/dd/yyyy):";

        //Ask user for decision deadline
        var dec = newWindow.document.createElement('conf');
        dec.setAttribute('style', 'white-space: pre;');
        dec.textContent = "\r\nPlease Enter the final version deadline (mm/dd/yyyy):";

        //input text box for searching by conference name
        var inputConferenceTitle = newWindow.document.createElement("input");
        inputConferenceTitle.setAttribute('type', 'text');

        //input text box for searching by conference URL
        var inputConferenceURL = newWindow.document.createElement("input");
        inputConferenceURL.setAttribute('type0', 'text');

        //input text box for searching by conference name
        var inputConfPlc = newWindow.document.createElement("input");
        inputConfPlc.setAttribute('type1', 'text');

        //input text box for conference name
        var inputConference = newWindow.document.createElement("input");
        inputConference.setAttribute('type2', 'text');

        //input text box for submission deadline
        var inputSub = newWindow.document.createElement("input");
        inputSub.setAttribute('type3', 'text');

        //input text box for notification deadline
        var inputConferenceNotif = newWindow.document.createElement("input");
        inputConferenceNotif.setAttribute('type4', 'text');

        //input text box for decision deadline
        var inputDec = newWindow.document.createElement("input");
        inputDec.setAttribute('type5', 'text');

        //create a submit button that will call the function to save inputs
        var submit_button = newWindow.document.createElement("button");
        submit_button.innerHTML = "Done";
        submit_button.id = "submit_button";
        submit_button.width = "20px";
        submit_button.height = "100px";
        submit_button.top = "100px";
        submit_button.left = "20px";

        submit_button.onclick = function() {
            //create an array to append the data entered for a new conference
            var newConference = [];

            //save new conference title
            var inTitle = inputConferenceTitle.value;
            newConference.push(inTitle);

            //save new conference URL
            var inURL = inputConferenceURL.value;
            newConference.push(inURL);

            //save new conference name
            var inConf = inputConference.value;
            newConference.push(inConf);

            //save the new conferences submission deadline
            var inSub = inputSub.value;
            newConference.push(inSub);

            //save the notification deadline
            var inNotif = inputConferenceNotif.value;
            newConference.push(inNotif);

            //save the new conferences decision deadline
            var inDec = inputDec.value;
            newConference.push(inDec);

            // display array for checking, close window, and return array containing new conference details
            console.log(newConference);
            console.log("Done");
            newWindow.close();
            return newConference;
        };

        //Add all elements to the pop-up window
        newWindow.document.body.appendChild(confTS);
        newWindow.document.body.appendChild(inputConferenceTitle);
        newWindow.document.body.appendChild(confURLS);
        newWindow.document.body.appendChild(inputConferenceURL);
        newWindow.document.body.appendChild(Or);
        newWindow.document.body.appendChild(confPlc);
        newWindow.document.body.appendChild(inputConfPlc);
        newWindow.document.body.appendChild(conf);
        newWindow.document.body.appendChild(inputConference);
        newWindow.document.body.appendChild(sub);
        newWindow.document.body.appendChild(inputSub);
        newWindow.document.body.appendChild(notif);
        newWindow.document.body.appendChild(inputConferenceNotif);
        newWindow.document.body.appendChild(dec);
        newWindow.document.body.appendChild(inputDec);
        newWindow.document.body.appendChild(submit_button);
    }

    /**
     * Conference Class
     */
    class Conference {
        //constructor (must include all fields atm)
        constructor(conf_name, conf_index, x, y, conf_field, conf_color, submission_deadline, decision_deadline, conferenceStart_date, conferenceEnd_date, notification_deadline, conf_location, radius, inner_radius, outer_radius, start_angle, end_angle, ring, arc) {
            //var. having to do with conference info.
            this.conf_name = conf_name;
            this.conf_index = conf_index;
            this.conf_field = conf_field;
            this.conf_color = conf_color;

            //var. having to do with conference vis.
            this.x = x;
            this.y = y;
            this.radius = radius;
            this.inner_radius = inner_radius;
            this.outer_radius = outer_radius;
            this.start_angle = start_angle;
            this.end_angle = end_angle;

            //var. having to do with both conf. vis. & conf. info.
            this.submission_deadline = submission_deadline;
            this.decision_deadline = decision_deadline;
            this.conferenceStart_date = conferenceStart_date;
            this.conferenceEnd_date = conferenceEnd_date;
            this.notification_deadline = notification_deadline;
            this.conf_location = conf_location;

            //conf. shapes
            this.ring = ring;
            this.arc = arc;
        }

        /**
         * showDetails
         * @params document, conference
         * document: used to append created elements to html
         * conference: used to grab data necessary to populate created elements
         *
         * showDetails is in charge of displaying the data corresponding to each conference.
         * It is a base template and used for all conferences, as they should all have the same
         * data fields.
         */
        showDetails(document, conference) {
            var details_element_ids = ["conferenceName", "mainParagraph", "deleteButton"];
            for (var i = 0; i < details_element_ids.length; i++) {
                if (document.getElementById(details_element_ids[i])){
                    var elem = document.getElementById(details_element_ids[i]);
                    elem.remove();
                }
            }

            //create a new container that will appear on the left side of the screen
            var container2 = document.createElement("div");
            container2.setAttribute("style","float: left;");
            document.body.appendChild(container2);

            var container3 = document.createElement("div2");
            container3.setAttribute("style","float: absolute;");
            container3.style.position = "absolute";
            container3.style.left = 1025 + 'px';
            container3.style.top = 175 +'px';
            document.body.appendChild(container3);

            // Header element, will contain Conference Name
            var h1 = document.createElement('h1');
            h1.id = "conferenceName";
            h1.textContent = conference.conf_name;
            var left = document.clientWidth/2;
            var top = document.clientHeight/2;
            //h1.style.left = left;
            //h1.style.top = top;
            //h1.setAttribute("style", "position: left; z-index: 1; left: "+left+"; top: "+top+"; width:200px; height:20px;");
            //h1.style.zIndex = 1;
            container2.appendChild(h1);
            //container2.appendChild(h1);

            // Paragraph element, unknown what this will contain
            var p1 = document.createElement('p1');
            p1.id = "mainParagraph";
            p1.setAttribute("style", "position: absolute; z-index: 1; left: "+left+"; top: "+top+"; width:190px; height:100px;");
            p1.textContent = "Conference Topic: " + conference.conf_field + "\r\nLocation: " + conference.conf_location + "\r\nSubmission Deadline: " + conference.submission_deadline + "\r\nNotification Deadline: " + conference.notification_deadline + "\r\nFinal Version Due: " + conference.decision_deadline;
            p1.setAttribute('class', 'note');
            p1.setAttribute('vertical-align', 'baseline');
            container2.appendChild(p1);

            var deleteButton = document.createElement("button");
            deleteButton.innerHTML = "Delete Conference";
            deleteButton.id = "deleteButton";
            deleteButton.width = "20px";
            deleteButton.height = "100px";
            deleteButton.top = "100px";
            deleteButton.left = "20px";
            container3.appendChild(deleteButton);

            deleteButton.onclick = function() {
                conference.delConf();
            }
        }

        /**
         * createConfVis
         * @params svg, conference, x, y, radius, start_angle, end_angle, color, ring_size, arc_size
         * svg: svg object, used to add created shapes into svg
         * x, y: Cartesian coordinates of the center of circle or arc to be created on the canvas
         * radius: the radius of the circle or arc being created
         * start_angle, end_angle: used to define start and end points if arc is being created
         * color: color of circle or arc
         * ring_size: width of stroke for ring
         * arc_size: width of stroke for arc
         *
         * createConfVis is in charge of creating the circles & arcs within canvas (for now)
         */
        //Create Conference Visualizations (ring & arc), and add click handlers. TODO: SHOULD CLICK HANDLERS BE TAKEN CARE OF IN THE SAME FUNCTION???
        static createConfRing(svg, document, conference, x, y, radius, color, ring_size) {
            //init. and append new conference ring to svg
            var new_conf_ring = svg.append("circle").attr("cx", x).attr("cy", y)
                .attr("r", radius)
                .attr("stroke", color).attr("stroke-width", ring_size)
                .style("fill", "none")
                .on("click", function() {
                    conference.showDetails(document, conference);
                });
            return new_conf_ring;
        }

        static createConfArc(svg, document, conference, x, y, radius, start_angle, end_angle, color, arc_size) {
            //init. and append new conference arc to svg
            var newly_built_arc = d3.svg.arc().innerRadius(radius - (arc_size/2))
                .outerRadius(radius + (arc_size/2))
                .startAngle(start_angle)
                .endAngle(end_angle);

            var new_conf_arc = svg.append("path").attr("d", newly_built_arc).attr("transform", "translate("+x+", "+y+")").style("fill", color)
                .on("click", function() {
                    conference.showDetails(document, conference);
                });
            return new_conf_arc;
        }

        static createConfVisuals(svg, document, conf, x, y, radius, start_angle, end_angle, conf_color, ring_size, arc_size) {
            conf.ring = Conference.createConfRing(svg, document, conf, x, y, radius, conf_color, ring_size);
            conf.arc = Conference.createConfArc(svg, document, conf, x, y, radius, start_angle, end_angle, conf_color, arc_size);
        }

        static delAndUpdateConfVis(svg, conference, conf_count, spacing, conferences, document, arc_size) {
            // remove ring and arc from d3 and svg
            conference.ring.remove();
            conference.arc.remove();

            // check if you need to update the visualization
            if (conference.conf_index < (conf_count - 1)) {
                console.log("Needs updating");

                for (var i = conference.conf_index+1; i < conf_count; i++) {
                    console.log("Currently updating");

                    conference = conferences[i];

                    //update ring
                    conference.conf_index -= 1;
                    conference.ring.attr("r", conference.radius - spacing);

                    //update arc
                    // 1) remove current arc
                    conference.arc.remove();
                    conference.arc = null;
                    // 2) create new, updated arc and re-add to conf object
                    conference.arc = Conference.createConfArc(svg, document, conference, conference.x, conference.y, conference.radius - spacing,
                        conference.start_angle, conference.end_angle, conference.conf_color, arc_size);
                }
            }

            // return updated conf_count
            return conf_count - 1;
        }

        static delConf() {
            console.log("Call to delAndUpdateConfVis");
        }
    }


    /*
     * main function call
     */
    function init() {
        // dataHandler object for any functions having to do with data handling (self explanatory)
        data_handler = new dataHandler();

        //svg creation
        var svg_width = document.body.clientWidth / 2;
        var svg_height = document.body.clientHeight;
        var svg = d3.select("#chart1").append("svg").attr("width", svg_width)
            .attr("height", svg_height);


        // conference temp. variables
        // having to do with creating visual aspect of conference
        var num_confs = 3;
        var conferenceStart_dates = [5, 6, 5];
        var conferenceEnd_dates = [9, 10, 11];
        var notification_deadlines = [1, 4, 17];
        var submission_deadlines = [24, 46, 52];
        var decision_deadlines = [48, 102, 256];

        // more conference information
        var conferences = [];
        var conf_names = ["IEEE CAMAD 2020", "RAI--Ei and Scopus 2020", "IWSMR 2020"];
        var conf_locations = ["Denver,CO,US", "Boston,MA,US", "Pittsburgh,PA,US"];
        var conf_fields = ["Robotics", "AI", "Physics"];
        var conf_colors = ["#f08950", "#9ce490", "#90c6e4"];

        //create conferences & their visuals and add all info to conferences_handler object
        conferences_handler = new VisualizationHandler(svg, document, svg_width/2, svg_height/2, conferences, num_confs, conf_names, conf_fields, conf_colors,
            submission_deadlines, decision_deadlines, conferenceStart_dates, conferenceEnd_dates, notification_deadlines, conf_locations);

        //create months ring
        conferences_handler.createMonthsRing(svg, conferences_handler.x, conferences_handler.y);

        //create date line
        var now = new Date();
        conferences_handler.createDateLine(svg, data_handler, now, conferences_handler.x, conferences_handler.y, conferences_handler.curr_radius);

        //TESTING, can be deleted if necessary
        console.log(conferences_handler.names);

        // UNDER CONSTRUCTION
        // STILL NEED TO REMOVE CONFERENCE FROM conferences, AND CHECK IF I NEED TO DO ANYTHING ELSE FOR DELETION
        //num_confs = Conference.delAndUpdateConfVis(svg, conferences[2], num_confs, spacing, conferences, document, arc_size);
    }

    //calls main function using
    $(document).ready(function() {
        init();
    });

</script>


</body>
</html>
